{"pageProps":{"post":{"id":"wpxml-check-copy-contents-csrf","title":"Check Copy Contents(CCC) の利用における注意点","content":"<html><head></head><body><div class=\"toc-wrapper\"><input type=\"checkbox\" class=\"toc-checkbox\" id=\"toc-checkbox-55mhsdht2f\" checked><label class=\"toc-title\" for=\"toc-checkbox-55mhsdht2f\">目次</label><nav class=\"toc\"><ol class=\"toc-level toc-level-1\"><li class=\"toc-item toc-item-h2\"><a class=\"toc-link toc-link-h2\" href=\"#追記201954\">追記：2019/5/4</a></li><li class=\"toc-item toc-item-h2\"><a class=\"toc-link toc-link-h2\" href=\"#想定される攻撃\">想定される攻撃</a></li><li class=\"toc-item toc-item-h2\"><a class=\"toc-link toc-link-h2\" href=\"#対策\">対策</a><ol class=\"toc-level toc-level-2\"><li class=\"toc-item toc-item-h3\"><a class=\"toc-link toc-link-h3\" href=\"#プログラムの修正による対策\">プログラムの修正による対策</a></li><li class=\"toc-item toc-item-h3\"><a class=\"toc-link toc-link-h3\" href=\"#運用による対策\">運用による対策</a></li></ol></li><li class=\"toc-item toc-item-h2\"><a class=\"toc-link toc-link-h2\" href=\"#補足\">補足</a></li></ol></nav></div><p><a href=\"https://wordpress.org/plugins/check-copy-contentsccc/\" target=\"_blank\" rel=\"noreferrer noopener\">Check Copy Contents(CCC)</a>はブログをコピーされたときに通知を行うことのできるプラグインです。</p>\n\n<p>このプラグインには最新のバージョン（v1.4.1）のプログラムに問題があるため使用には注意が必要です。</p>\n\n<h2 id=\"追記201954\">追記：2019/5/4<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#追記201954\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h2>\n\n<p>4/25 に報告してすぐに対応されました。</p>\n\n<p>メンテナーが恐らく修正を放棄したため、クローズになり現在はダウンロードできません。</p>\n\n<p>使用している人は削除をお勧めします。</p>\n\n<h2 id=\"想定される攻撃\">想定される攻撃<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#想定される攻撃\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h2>\n\n<p>プログラムの欠陥を利用することでCCCの設定はすべて変更することが可能です。</p>\n\n<figure class=\"wp-block-image\"><a href=\"https://technote.space/uploads/2019/02/201902111443.png\"><img src=\"https://technote.space/uploads/2019/02/201902111443-1024x511.png\" alt=\"\" class=\"wp-image-990\"></a></figure>\n\n<p>したがって通知先のメールアドレスを適当な企業などに、通知メールの件名を脅迫めいたものにそれぞれ変更され、<span class=\"double-underline\">なりすましの犯罪予告に利用される可能性</span>があります。</p>\n\n<p>フロント側はCSRF対策がされていますが、<span class=\"double-underline\">コピーされた文章だけではなくURLやIP、リファラなどの情報もAjaxで送られたものをそのまま使用する仕様</span>になっているため、これらも容易に書き換えることが可能であり、そのリスクはさらに高くなります。</p>\n\n<ul class=\"wp-block-gallery columns-2 is-cropped\"><li class=\"blocks-gallery-item\"><figure><a href=\"https://technote.space/uploads/2019/02/201902111545-1-1024x314.png\" target=\"_blank\" rel=\"noreferrer noopener\"><img src=\"https://technote.space/uploads/2019/02/201902111545-1-1024x314.png\" alt=\"\" data-id=\"1007\" data-link=\"/wordpress/check-copy-contents-csrf/attachment/201902111545-2\" class=\"wp-image-1007\"></a><figcaption>適当なPOSTツールから送信</figcaption></figure></li><li class=\"blocks-gallery-item\"><figure><a href=\"https://technote.space/uploads/2019/02/201902111546-1.png\"><img src=\"https://technote.space/uploads/2019/02/201902111546-1.png\" alt=\"\" data-id=\"1008\" data-link=\"/wordpress/check-copy-contents-csrf/attachment/201902111546-2\" class=\"wp-image-1008\"></a><figcaption>実際に送信されたメール</figcaption></figure></li></ul>\n\n<p>見てわかる通り、メールの内容のほとんどの箇所を偽装することが可能です。<br>定型文が入りますが、書き換えられた文章の量を増やしたり文章を工夫することでごまかすことは可能です。</p>\n\n<p>また<span class=\"double-underline\">送信元は変わらずブログに設定されたメールアドレス</span>のままです。</p>\n\n<h2 id=\"対策\">対策<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#対策\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h2>\n\n<p>このプラグインを今後も使用する場合は各自で対策を行う必要があります。</p>\n\n<h3 id=\"プログラムの修正による対策\">プログラムの修正による対策<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#プログラムの修正による対策\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h3>\n\n<p>２か所プログラムを書き換えることで対応することが可能です。</p>\n\n<p><em>views/admin.php</em> 22行目 を修正</p>\n\n<pre class=\"language-php\" style=\"background: #2e3440\"><code class=\"language-php\"><span style=\"color: #D8DEE9FF\">if (isset($_POST['mail'], $_POST['subject'], $_POST['reply'], $_POST['letters'])){</span></code></pre>\n\n<p>以下のように修正します。</p>\n\n<pre class=\"language-php\" style=\"background: #2e3440\"><code class=\"language-php\"><span style=\"color: #D8DEE9FF\">if (isset($_POST['ccc_nonce']) </span><span style=\"color: #D8DEE9\">&#x26;&#x26;</span><span style=\"color: #D8DEE9FF\"> wp_verify_nonce($_POST['ccc_nonce'], 'ccc_nonce') </span><span style=\"color: #D8DEE9\">&#x26;&#x26;</span><span style=\"color: #D8DEE9FF\"> isset($_POST['mail'], $_POST['subject'], $_POST['reply'], $_POST['letters'])){</span></code></pre>\n\n<p><em>views/admin.php</em> 103行目 の後ろに追記</p>\n\n<pre class=\"language-php\" style=\"background: #2e3440\"><code class=\"language-php\"><span style=\"color: #81A1C1\">&#x3C;form</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">action</span><span style=\"color: #D8DEE9FF\">=</span><span style=\"color: #ECEFF4\">\"\"</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">method</span><span style=\"color: #D8DEE9FF\">=</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">post</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #81A1C1\">></span>\n<span style=\"color: #81A1C1\">&#x3C;table</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">class</span><span style=\"color: #D8DEE9FF\">=</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">type01</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #81A1C1\">></span></code></pre>\n\n<p>の箇所にnonce生成のコードを追加します。</p>\n\n<pre class=\"language-php\" style=\"background: #2e3440\"><code class=\"language-php\"><span style=\"color: #81A1C1\">&#x3C;form</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">action</span><span style=\"color: #D8DEE9FF\">=</span><span style=\"color: #ECEFF4\">\"\"</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">method</span><span style=\"color: #D8DEE9FF\">=</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">post</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #81A1C1\">></span>\n<span style=\"color: #81A1C1\">&#x3C;?php</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #88C0D0\">wp_nonce_field</span><span style=\"color: #D8DEE9FF\">(</span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #A3BE8C\">ccc_nonce</span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #D8DEE9FF\">, </span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #A3BE8C\">ccc_nonce</span><span style=\"color: #ECEFF4\">'</span><span style=\"color: #D8DEE9FF\">)</span><span style=\"color: #81A1C1\">;?></span>\n<span style=\"color: #81A1C1\">&#x3C;table</span><span style=\"color: #D8DEE9FF\"> </span><span style=\"color: #8FBCBB\">class</span><span style=\"color: #D8DEE9FF\">=</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #A3BE8C\">type01</span><span style=\"color: #ECEFF4\">\"</span><span style=\"color: #81A1C1\">></span></code></pre>\n\n<h3 id=\"運用による対策\">運用による対策<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#運用による対策\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h3>\n\n<p>CSRFは主にサイト運営者のログイン状態を悪用します。</p>\n\n<p>したがって自分のサイトのコメント欄や掲示板などのリンクをクリックする場合に、<span class=\"double-underline\">自分のサイトにログインしていない状態</span>かどうかを確認してください。</p>\n\n<p>シークレットウィンドウを利用するのもよいでしょう。</p>\n\n<p>普段から記事を書く時以外、ログアウトしておくと安心です。</p>\n\n<h2 id=\"補足\">補足<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#補足\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h2>\n\n<p>送信元の情報としてAjaxでPOSTされた値を使用していることも問題です。</p>\n\n<p>IP情報に関しては以下の修正で改善されます。</p>\n\n<p><em>check-copy-contents.php</em> 169行目 を修正</p>\n\n<pre class=\"language-php\" style=\"background: #2e3440\"><code class=\"language-php\"><span style=\"color: #D8DEE9FF\">$remote_addr = $_POST['remote_addr'];</span></code></pre>\n\n<p>以下のように修正します。</p>\n\n<pre class=\"language-php\" style=\"background: #2e3440\"><code class=\"language-php\"><span style=\"color: #D8DEE9FF\">$remote_addr = $_SERVER[\"REMOTE_ADDR\"];</span></code></pre>\n\n<p>　</p>\n\n<p>この脆弱性は自作のCSRF検出プラグインによって発見されました。</p>\n\n<div class=\"blog-card\"><iframe src=\"https://blog-card-ten.vercel.app/card/https%3A%2F%2Ftechnote.space%2Fwordpress%2Fcsrf-detector?id=blog-card-1kqg6e4f81&#x26;referrer=https%3A%2F%2Ftechnote.space%2Fposts%2Fwpxml-check-copy-contents-csrf%2F\" frameborder=\"0\" scrolling=\"no\" loading=\"lazy\" data-id=\"blog-card-1kqg6e4f81\"></iframe></div>\n<!-- /wp:paragraph --></body></html>","excerpt":"Check Copy Contents(CCC)はブログをコピーされたときに通知を行うことのできるプラグインです。 このプラグインには最新のバージョン（v1.4.1）のプログラムに問題があるため使用には注意が必要です。 追記：2019/5/...","postType":"post","tags":[{"slug":"csrf","name":"CSRF"},{"slug":"%e3%82%bb%e3%82%ad%e3%83%a5%e3%83%aa%e3%83%86%e3%82%a3","name":"セキュリティ"},{"slug":"%e8%84%86%e5%bc%b1%e6%80%a7","name":"脆弱性"}],"thumbnail":"https://technote.space/uploads/2018/11/computer_virus_backdoor.png","dominantColor":"rgba(171,173,174,0.3686274509803922)","createdAt":"2019-02-11T06:09:48.000Z","updatedAt":null},"prev":{"id":"wpxml-add-richtext-toolbar-button","title":"Gutenberg用の文章修飾プラグインを開発しました","excerpt":"Gutenberg エディタのツールバーに文章修飾用のボタンを追加するプラグインを作成しました。 導入手順   1. 最新版をGitHubからダウンロード     release.zip  2. 「プラグインのアップロード」からインストール...","postType":"post","tags":[{"slug":"dropdown","name":"DropDown"},{"slug":"gutenberg","name":"Gutenberg"},{"slug":"richtext","name":"RichText"},{"slug":"%e3%83%84%e3%83%bc%e3%83%ab%e3%83%90%e3%83%bc","name":"ツールバー"},{"slug":"%e3%83%97%e3%83%a9%e3%82%b0%e3%82%a4%e3%83%b3","name":"プラグイン"},{"slug":"%e3%83%aa%e3%83%83%e3%83%81%e3%83%86%e3%82%ad%e3%82%b9%e3%83%88","name":"リッチテキスト"}],"thumbnail":"https://technote.space/uploads/2019/02/banner-772x250-1.png","createdAt":"2019-02-14T20:30:52.000Z","updatedAt":null},"next":{"id":"wpxml-marker-animation-for-gutenberg","title":"Marker AnimationプラグインをGutenbergエディタに対応させました","excerpt":"Marker Animationプラグインは蛍光ペンを引くようなアニメーションを設定できるようにするWordPressのプラグインです。 <a href=\"\">動作デモはこちら</a>   ツールバーにボタンを追加  Gutenbergのツ...","postType":"post","tags":[{"slug":"dropdown","name":"DropDown"},{"slug":"gutenberg","name":"Gutenberg"},{"slug":"richtext","name":"RichText"},{"slug":"%e3%83%aa%e3%83%83%e3%83%81%e3%83%86%e3%82%ad%e3%82%b9%e3%83%88","name":"リッチテキスト"}],"thumbnail":"https://technote.space/uploads/2018/12/banner-772x250.png","createdAt":"2019-02-06T08:42:43.000Z","updatedAt":null},"headerPages":[],"footerPages":[{"label":"About","url":"/pages/wpxml-about/"},{"label":"プライバシーポリシー","url":"/pages/wpxml-privacy-policy/"},{"label":"お問い合わせ","url":"/pages/wpxml-contact/"}]},"__N_SSG":true}