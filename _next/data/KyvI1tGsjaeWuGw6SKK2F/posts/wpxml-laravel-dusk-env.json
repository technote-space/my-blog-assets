{"pageProps":{"post":{"id":"wpxml-laravel-dusk-env","title":"【Laravel】Laravel Dusk時に使用される .env ファイル","content":"<html><head></head><body><div class=\"toc-wrapper\"><input type=\"checkbox\" class=\"toc-checkbox\" id=\"toc-checkbox-16ig6avlri\" checked><label class=\"toc-title\" for=\"toc-checkbox-16ig6avlri\">目次</label><nav class=\"toc\"><ol class=\"toc-level toc-level-1\"><li class=\"toc-item toc-item-h2\"><a class=\"toc-link toc-link-h2\" href=\"#env-file\">通常使用される .env</a></li><li class=\"toc-item toc-item-h2\"><a class=\"toc-link toc-link-h2\" href=\"#laravel-dusk-で使用される-env\">Laravel Dusk で使用される .env</a><ol class=\"toc-level toc-level-2\"><li class=\"toc-item toc-item-h3\"><a class=\"toc-link toc-link-h3\" href=\"#テストを実行するプロセス\">テストを実行するプロセス</a></li><li class=\"toc-item toc-item-h3\"><a class=\"toc-link toc-link-h3\" href=\"#テスト対象のプロセス\">テスト対象のプロセス</a></li><li class=\"toc-item toc-item-h3\"><a class=\"toc-link toc-link-h3\" href=\"#create-env\">.env の生成</a></li></ol></li><li class=\"toc-item toc-item-h2\"><a class=\"toc-link toc-link-h2\" href=\"#私の考えるベストプラクティス\">私の考えるベストプラクティス</a><ol class=\"toc-level toc-level-2\"><li class=\"toc-item toc-item-h3\"><a class=\"toc-link toc-link-h3\" href=\"#テストを実行するプロセスは-local-ではないパラメータで実行\">テストを実行するプロセスは local ではないパラメータで実行</a></li><li class=\"toc-item toc-item-h3\"><a class=\"toc-link toc-link-h3\" href=\"#db設定の共通化\">DB設定の共通化</a></li></ol></li><li class=\"toc-item toc-item-h2\"><a class=\"toc-link toc-link-h2\" href=\"#補足\">補足</a><ol class=\"toc-level toc-level-2\"><li class=\"toc-item toc-item-h3\"><a class=\"toc-link toc-link-h3\" href=\"#env-の内容が反映されない\">.env の内容が反映されない</a></li></ol></li></ol></nav></div><p>Laravel Dusk は Laravel で手軽にブラウザテストを行うためのライブラリです。</p>\n\n<p>とても便利なライブラリですが、通常のユニットテストと環境変数ファイルに関する動作が大きく異なっているため注意が必要です。</p>\n\n<h2 id=\"env-file\">通常使用される .env<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#env-file\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h2>\n\n<p> <em><strong><code>--env</code></strong></em> で設定されるパラメータまたは 環境変数 <strong><em>APP_ENV</em></strong> で使用されるファイルが決まり、例えば <code><strong><em>--env=environment</em></strong></code> とした場合には <strong><em>.env.environment</em></strong> が使用されます。</p>\n\n<p>phpunit を実行すると <em>phpunit.xml</em> の設定によって <em><code>APP_ENV=testing</code></em> が自動で設定されるため、 <strong><em>.env.testing</em></strong> が使用されます。</p>\n\n<h2 id=\"laravel-dusk-で使用される-env\">Laravel Dusk で使用される .env<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#laravel-dusk-で使用される-env\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h2>\n\n<p>まず Laravel Dusk はユニットテストと異なり２つのプロセスが走ることを理解する必要があります。</p>\n\n<ul><li>テストを実行するプロセス</li><li>テストでアクセスする対象のプロセス</li></ul>\n\n<h3 id=\"テストを実行するプロセス\">テストを実行するプロセス<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#テストを実行するプロセス\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h3>\n\n<p>Laravel Dusk は前述のユニットテストとは異なり環境変数などは設定されません。</p>\n\n<pre class=\"language-shell\" style=\"background: #2e3440\"><code class=\"language-shell\"><span style=\"color: #D8DEE9FF\">php artisan dusk</span></code></pre>\n\n<p>したがってテストを実行するプロセスでは <em><strong>.env</strong></em> が使用されます。ただしこの .env は後述の機能によって生成されたものです。</p>\n\n<p><code>--env</code> で明示的にパラメータを指定することで他の .env を使用することが可能です。</p>\n\n<pre class=\"language-shell\" style=\"background: #2e3440\"><code class=\"language-shell\"><span style=\"color: #D8DEE9FF\">php artisan dusk --env=environment</span></code></pre>\n\n<p>⇒ <em><strong>.env.environment</strong></em></p>\n\n<h3 id=\"テスト対象のプロセス\">テスト対象のプロセス<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#テスト対象のプロセス\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h3>\n\n<p>Laravel Dusk によって起動するプロセスでは <strong><em>.env</em></strong> が使用されます。ただしこの .env も後述の機能によって生成されたものです。</p>\n\n<h3 id=\"create-env\">.env の生成<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#create-env\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h3>\n\n<p>Laravel Dusk 起動時に <code><strong>--env </strong></code>または 環境変数 environment によって .env.dusk.{environment} が .env にコピーされます。</p>\n\n<p>通常は何も指定していない状態（local）のため、<em><strong>.env.dusk.local</strong></em> が <strong><em>.env</em></strong> にコピーされ、それらが共通して『テストを実行するプロセス』と『テスト対象のプロセス』で使用されます。</p>\n\n<p>ただし、テスト対象のプロセスでは<span class=\"double-underline\">起動時に元の .env を読みこみ、その後生成した .env で上書きする動作</span>のため、上書きされないものはそのまま設定が残ります。</p>\n\n<p>この動作によってテストがうまくいかない場合があるため注意が必要です。</p>\n\n<p>例えば通常は mysql を使用していて、テストの時は sqlite を使用する場合を考えます。</p>\n\n<pre class=\"language-yml\" style=\"background: #2e3440\"><code class=\"language-yml\"><span style=\"color: #4C566A\"># 通常時</span>\n<span style=\"color: #A3BE8C\">DB_CONNECTION=mysql</span>\n<span style=\"color: #A3BE8C\">DB_DATABASE=laravel</span></code></pre>\n\n<pre class=\"language-yml\" style=\"background: #2e3440\"><code class=\"language-yml\"><span style=\"color: #4C566A\"># テスト時</span>\n<span style=\"color: #A3BE8C\">DB_CONNECTION=sqlite</span></code></pre>\n\n<p>sqlite は DB_DATABASE を指定しない場合は database ディレクトリ下に database.sqlite という名前でDBが作成されます。</p>\n\n<p>しかし上の例の場合は .env で <em><strong>DB_DATABASE=laravel</strong></em><strong> </strong>が設定されますがテスト時の設定では指定していないため設定が残り、プロジェクトルートに laravel という名前でDBが作成されます。</p>\n\n<p>一方テスト対象のプロセスは既に生成されている .env を読みこむだけなので、DB_DATABASE は設定されていない状態であり、database ディレクトリ下の database.sqlite が使用されます。</p>\n\n<p>したがってテストを実行するプロセスでログイン用のユーザを作成してその情報でログインするテストを行った場合に、<span class=\"double-underline\">テスト対象のプロセスの使用するDBは別</span>であるためログインはもちろん失敗してしまいます。</p>\n\n<h2 id=\"私の考えるベストプラクティス\">私の考えるベストプラクティス<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#私の考えるベストプラクティス\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h2>\n\n<ul><li>テストを実行するプロセスとテスト対象のプロセスの使用するDBが共通</li><li>テストを実行するプロセスが元の .env の状態に影響を受けない（予期せぬ動作を避ける）</li></ul>\n\n<p>は満たしておいたほうがよいでしょう。</p>\n\n<h3 id=\"テストを実行するプロセスは-local-ではないパラメータで実行\">テストを実行するプロセスは local ではないパラメータで実行<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#テストを実行するプロセスは-local-ではないパラメータで実行\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h3>\n\n<p>元の .env の影響を受けないように <code>--env</code> でパラメータを明示的に指定します。</p>\n\n<p>ここでは例として dusk とします。</p>\n\n<pre class=\"language-shell\" style=\"background: #2e3440\"><code class=\"language-shell\"><span style=\"color: #D8DEE9FF\">php artisan dusk --env=dusk</span></code></pre>\n\n<p>すると、テストを実行するプロセスでは <a href=\"#env-file\">通常使用される .env</a> の通り .env.dusk が使用され、さらに <a href=\"#create-env\">.env の生成</a> の通り .env.dusk.dusk が .env にコピーされます。</p>\n\n<h3 id=\"db設定の共通化\">DB設定の共通化<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#db設定の共通化\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h3>\n\n<p>前述のように .env が使用されるため、<strong><em>.env.dusk</em></strong> と <strong><em>.env.dusk.dusk</em></strong> の設定を同じにすることで共通のDBを使用することが可能です。</p>\n\n<h2 id=\"補足\">補足<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#補足\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h2>\n\n<h3 id=\"env-の内容が反映されない\">.env の内容が反映されない<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#env-の内容が反映されない\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h3>\n\n<p>config がキャッシュされているのが影響している可能性が高いです。</p>\n\n<p>Laravel Dusk テスト時は以下のコマンドでキャッシュをクリアしておいたほうがよいです。</p>\n\n<pre class=\"language-shell\" style=\"background: #2e3440\"><code class=\"language-shell\"><span style=\"color: #D8DEE9FF\">php artisan config:clear</span></code></pre>\n<!-- /wp:code --></body></html>","excerpt":"Laravel Dusk は Laravel で手軽にブラウザテストを行うためのライブラリです。 とても便利なライブラリですが、通常のユニットテストと環境変数ファイルに関する動作が大きく異なっているため注意が必要です。 通常使用される .E...","postType":"post","tags":[{"slug":"dusk","name":"dusk"},{"slug":"laravel","name":"Laravel"}],"thumbnail":"https://raw.githubusercontent.com/technote-space/my-blog-assets/main/uploads/2019/08/201908151553.png","dominantColor":"rgba(251,80,59,0.1803921568627451)","createdAt":"2019-08-17T15:42:03.000Z","updatedAt":null},"prev":{"id":"wpxml-add-component-to-blockeditor","title":"【Gutenberg】ブロックエディタに任意の要素を追加する","excerpt":"基本はREACT ブロックエディタは React なので、ブロックエディタの持っている情報などを利用するには React を使用したほうがよいです。 コンポーネントを作成  通常通りにコンポーネントを作成します。  data.select ...","postType":"post","thumbnail":"https://raw.githubusercontent.com/technote-space/my-blog-assets/main/uploads/2018/12/banner-772x250.jpg","createdAt":"2019-08-19T08:59:36.000Z","updatedAt":null},"next":{"id":"wpxml-use-vue-i18","title":"【Vue.js】i18n をテンプレート以外から利用する","excerpt":"Vue I18n の設定例 plugins/i18n.js app.js  テンプレート内で使用する場合は $t を使用すればよい。  Vueファイル以外のJavaScriptファイル内などから使用する場合は new VueI18n したも...","postType":"post","thumbnail":"https://raw.githubusercontent.com/technote-space/my-blog-assets/main/uploads/2019/08/201908151529.png","createdAt":"2019-08-16T04:59:39.000Z","updatedAt":null},"headerPages":[],"footerPages":[{"label":"About","url":"/pages/wpxml-about/"},{"label":"プライバシーポリシー","url":"/pages/wpxml-privacy-policy/"},{"label":"お問い合わせ","url":"/pages/wpxml-contact/"}]},"__N_SSG":true}