{"pageProps":{"post":{"id":"wpxml-programming-server-monitoring","title":"Google Analyticsのリアルタイムレポートを利用してアクセス急増を監視","content":"<html><head></head><body><div class=\"toc-wrapper\"><input type=\"checkbox\" class=\"toc-checkbox\" id=\"toc-checkbox-0nveas2hqm\" checked><label class=\"toc-title\" for=\"toc-checkbox-0nveas2hqm\">目次</label><nav class=\"toc\"><ol class=\"toc-level toc-level-1\"><li class=\"toc-item toc-item-h2\"><a class=\"toc-link toc-link-h2\" href=\"#機能\">機能</a></li><li class=\"toc-item toc-item-h2\"><a class=\"toc-link toc-link-h2\" href=\"#手順\">手順</a><ol class=\"toc-level toc-level-2\"><li class=\"toc-item toc-item-h3\"><a class=\"toc-link toc-link-h3\" href=\"#slackに通知用のチャネルを追加\">Slackに通知用のチャネルを追加</a></li><li class=\"toc-item toc-item-h3\"><a class=\"toc-link toc-link-h3\" href=\"#slackに着信webフックアプリを追加する\">Slackに着信Webフックアプリを追加する</a></li><li class=\"toc-item toc-item-h3\"><a class=\"toc-link toc-link-h3\" href=\"#google-apps-scriptにプログラムを記述\">Google Apps Scriptにプログラムを記述</a></li></ol></li><li class=\"toc-item toc-item-h2\"><a class=\"toc-link toc-link-h2\" href=\"#動作\">動作</a></li><li class=\"toc-item toc-item-h2\"><a class=\"toc-link toc-link-h2\" href=\"#まとめ\">まとめ</a></li></ol></nav></div>Google Analyticsのリアルタイムレポート機能とGoogle Apps Scriptを使用して簡単に簡易サーバ監視を作成できたのでその手順を記録しておきます。<br /><h2 id=\"機能\">機能<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#機能\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h2><br /><ol><br /> \t<li>15分おきにリアルタイムのユーザー数を取得</li><br /> \t<li>設定してある閾値よりも大きい場合にslackへ通知</li><br /></ol><br /><h2 id=\"手順\">手順<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#手順\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h2><br /><h3 id=\"slackに通知用のチャネルを追加\">Slackに通知用のチャネルを追加<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#slackに通知用のチャネルを追加\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h3><br />例：#alert<br /><h3 id=\"slackに着信webフックアプリを追加する\">Slackに着信Webフックアプリを追加する<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#slackに着信webフックアプリを追加する\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h3><br /><ol><br /> \t<li>「incomming web hook」で検索して着信Webフックを選択<a href=\"https://raw.githubusercontent.com/technote-space/my-blog-assets/main/uploads/2018/10/201810030326.png\"><img class=\"size-medium wp-image-261 aligncenter\" src=\"https://raw.githubusercontent.com/technote-space/my-blog-assets/main/uploads/2018/10/201810030326-300x96.png\" alt=\"\" width=\"300\" height=\"96\"></a></li><br /> \t<li>「設定を追加」を押下<a href=\"https://raw.githubusercontent.com/technote-space/my-blog-assets/main/uploads/2018/10/201810030327.png\"><img class=\"size-medium wp-image-262 aligncenter\" src=\"https://raw.githubusercontent.com/technote-space/my-blog-assets/main/uploads/2018/10/201810030327-300x124.png\" alt=\"\" width=\"300\" height=\"124\"></a></li><br /> \t<li>追加した通知用チャネルを選択した状態で追加ボタンを押下<a href=\"https://raw.githubusercontent.com/technote-space/my-blog-assets/main/uploads/2018/10/201810030330.png\"><img class=\"size-medium wp-image-263 aligncenter\" src=\"https://raw.githubusercontent.com/technote-space/my-blog-assets/main/uploads/2018/10/201810030330-300x106.png\" alt=\"\" width=\"300\" height=\"106\"></a></li><br /></ol><br />Webhook URLを使用します。<br /><br /><a href=\"https://raw.githubusercontent.com/technote-space/my-blog-assets/main/uploads/2018/10/201810030334.png\"><img class=\"alignnone size-medium wp-image-265\" src=\"https://raw.githubusercontent.com/technote-space/my-blog-assets/main/uploads/2018/10/201810030334-300x200.png\" alt=\"\" width=\"300\" height=\"200\"></a><br /><h3 id=\"google-apps-scriptにプログラムを記述\">Google Apps Scriptにプログラムを記述<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#google-apps-scriptにプログラムを記述\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h3><br /><div class=\"blog-card\"><iframe src=\"https://blog-card-ten.vercel.app/card/https%3A%2F%2Fscript.google.com%2Fhome?id=blog-card-e0v8t5qhh9&#x26;referrer=https%3A%2F%2Ftechnote.space%2Fposts%2Fwpxml-programming-server-monitoring%2F\" frameborder=\"0\" scrolling=\"no\" loading=\"lazy\" data-id=\"blog-card-e0v8t5qhh9\"></iframe></div><br /><ol><br /> \t<li>適当にプロジェクトを作成します。</li><br /> \t<li>プロパティを設定します。<br /><ol><br /> \t<li>「ファイル」→「プロジェクトのプロパティ」を選択します。<a href=\"https://raw.githubusercontent.com/technote-space/my-blog-assets/main/uploads/2018/10/201810030340.png\"><img class=\"size-medium wp-image-267 aligncenter\" src=\"https://raw.githubusercontent.com/technote-space/my-blog-assets/main/uploads/2018/10/201810030340-300x206.png\" alt=\"\" width=\"300\" height=\"206\"></a></li><br /> \t<li>スクリプトのプロパティに設定を追加します。<br /><table><br /><tbody><br /><tr><br /><th>プロパティ</th><br /><th>値</th><br /></tr><br /><tr><br /><td>ID</td><br /><td>Google AnalyticsのビューID<br /><br /><a href=\"https://raw.githubusercontent.com/technote-space/my-blog-assets/main/uploads/2018/10/201810030345.png\"><img class=\"alignnone size-medium wp-image-268\" src=\"https://raw.githubusercontent.com/technote-space/my-blog-assets/main/uploads/2018/10/201810030345-300x102.png\" alt=\"\" width=\"300\" height=\"102\"></a><br /><br />（例：123456789）</td><br /></tr><br /><tr><br /><td>THRESHOLD</td><br /><td>閾値（例：50）</td><br /></tr><br /><tr><br /><td>COLOR</td><br /><td>色（例：#D00）</td><br /></tr><br /><tr><br /><td>TITLE_LINK</td><br /><td>タイトルリンク<br /><br />（google analyticsのリンクを指定しておくと便利）</td><br /></tr><br /><tr><br /><td>URL</td><br /><td>上で取得したWebhook URL</td><br /></tr><br /></tbody><br /></table><br /></li><br /> \t<li>保存を押下</li><br /></ol><br /></li><br /> \t<li>以下のプログラムを追加します。<br /><pre>function run() {<br />  notify(getUserNumber());<br />}<br /><br />function getUserNumber() {<br />  var ID = PropertiesService.getScriptProperties().getProperty(\"ID\");<br />  var rows = Analytics.Data.Realtime.get('ga:' + ID, 'rt:activeUsers').getRows();<br />  if (rows === undefined) return 0;<br />  return rows[0][0];<br />}<br /><br />function notify(number) {<br />  var THRESHOLD = PropertiesService.getScriptProperties().getProperty(\"THRESHOLD\");<br />  if (number > THRESHOLD) {<br />    slack(getTitle(number, THRESHOLD), getMessage(number, THRESHOLD));<br />  }<br />}<br /><br />function getTitle(number, threshold) {<br />  return \"リアルタイムユーザー数が閾値を超えています\";<br />}<br /><br />function getMessage(number, threshold) {<br />  return \"ユーザー数：\" + number + \"\\n閾値：\" + threshold;<br />}<br /><br />function createPayload(title, message) {<br />  var COLOR = PropertiesService.getScriptProperties().getProperty(\"COLOR\");<br />  var TITLE_LINK = PropertiesService.getScriptProperties().getProperty(\"TITLE_LINK\");<br />  return JSON.stringify({<br />    attachments: [{<br />      fallback: title,<br />      pretext: title,<br />      color: COLOR,<br />      title: \"アクセスアラート\",<br />      title_link: TITLE_LINK,<br />      text: message<br />    }]<br />  });<br />}<br /><br />function slack(payload) {<br />  var URL = PropertiesService.getScriptProperties().getProperty(\"URL\");<br />  UrlFetchApp.fetch(URL, {<br />    method: \"POST\",<br />    payload: createPayload(title, message)<br />  });<br />}<br /></pre><br /></li><br /> \t<li>トリガーを設定します。<br /><ol><br /> \t<li>設定ボタンを押下<a href=\"https://raw.githubusercontent.com/technote-space/my-blog-assets/main/uploads/2018/10/201810030411.png\"><img class=\"size-medium wp-image-278 aligncenter\" src=\"https://raw.githubusercontent.com/technote-space/my-blog-assets/main/uploads/2018/10/201810030411-300x149.png\" alt=\"\" width=\"300\" height=\"149\"></a></li><br /> \t<li>15分ごとのトリガーを設定<a href=\"https://raw.githubusercontent.com/technote-space/my-blog-assets/main/uploads/2018/10/201810030409.png\"><img class=\"size-medium wp-image-276 aligncenter\" src=\"https://raw.githubusercontent.com/technote-space/my-blog-assets/main/uploads/2018/10/201810030409-300x93.png\" alt=\"\" width=\"300\" height=\"93\"></a></li><br /> \t<li>保存を押下</li><br /></ol><br /></li><br /></ol><br /><h2 id=\"動作\">動作<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#動作\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h2><br />これまでの手順で設定は終わりです。<br /><br />15分ごとのチェック時にリアルタイムユーザー数が閾値を超えていると以下のようなメッセージがslackに届くはずです。<br /><br /><a href=\"https://raw.githubusercontent.com/technote-space/my-blog-assets/main/uploads/2018/10/201810030354.png\"><img class=\"alignnone size-medium wp-image-271\" src=\"https://raw.githubusercontent.com/technote-space/my-blog-assets/main/uploads/2018/10/201810030354-300x112.png\" alt=\"\" width=\"300\" height=\"112\"></a><br /><h2 id=\"まとめ\">まとめ<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#まとめ\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h2><br />今回は閾値を超えた場合に通知を送る設定にしましたが、逆に少なすぎる場合も設定することも簡単にできそうです。<br /><br />外部サーバやサービスを用意するのが面倒な場合はこれで十分だと思います。</body></html>","excerpt":"Google Analyticsのリアルタイムレポート機能とGoogle Apps Scriptを使用して簡単に簡易サーバ監視を作成できたのでその手順を記録しておきます。 機能 1. 15分おきにリアルタイムのユーザー数を取得  2. 設定...","postType":"post","tags":[{"slug":"gas","name":"GAS"},{"slug":"google-analytics","name":"Google Analytics"},{"slug":"slack","name":"Slack"},{"slug":"%e3%82%b5%e3%83%bc%e3%83%90%e7%9b%a3%e8%a6%96","name":"サーバ監視"}],"thumbnail":"https://raw.githubusercontent.com/technote-space/my-blog-assets/main/uploads/2018/10/computer_server.png","dominantColor":"rgba(157,156,157,0.7450980392156863)","createdAt":"2018-10-02T19:14:38.000Z","updatedAt":null},"prev":{"id":"wpxml-programming-server-monitoring-gmail","title":"GASとGmailの連携を試してみる","excerpt":"Google Analyticsのリアルタイムユーザ数をGASを使用してチェックして、閾値を超えたらslackに通知ことは簡単に実装できました。 ただ、slackを普段使用していない場合はメールのほうが便利かと思うので、その方法も試してみま...","postType":"post","thumbnail":"https://raw.githubusercontent.com/technote-space/my-blog-assets/main/uploads/2018/10/computer_server.png","createdAt":"2018-10-03T06:10:42.000Z","updatedAt":null},"next":{"id":"wpxml-wp-related-post-jp","title":"Elasticsearchのような検索機能を提供するためのWordPressのプラグインを開発しました","excerpt":"WordPressはデフォルトでキーワード検索機能がありますが、精度はあまりよくありません。 具体的には、例えば「php wordpress 管理サイト」のように検索した場合、これらすべての単語を含んでいる記事しか引っかかりません。 「wo...","postType":"post","thumbnail":"https://raw.githubusercontent.com/technote-space/my-blog-assets/main/uploads/2018/10/logo-elastic.png","createdAt":"2018-10-01T19:59:32.000Z","updatedAt":null},"headerPages":[],"footerPages":[{"label":"About","url":"/pages/wpxml-about/"},{"label":"プライバシーポリシー","url":"/pages/wpxml-privacy-policy/"},{"label":"お問い合わせ","url":"/pages/wpxml-contact/"}]},"__N_SSG":true}