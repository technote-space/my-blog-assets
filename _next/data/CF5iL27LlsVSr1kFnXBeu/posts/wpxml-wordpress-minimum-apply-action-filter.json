{"pageProps":{"post":{"id":"wpxml-wordpress-minimum-apply-action-filter","title":"WordPressのアクションやフィルタの適用を最小限にする","content":"<html><head></head><body><div class=\"toc-wrapper\"><input type=\"checkbox\" class=\"toc-checkbox\" id=\"toc-checkbox-smmlm10tu9\" checked><label class=\"toc-title\" for=\"toc-checkbox-smmlm10tu9\">目次</label><nav class=\"toc\"><ol class=\"toc-level toc-level-1\"><li class=\"toc-item toc-item-h2\"><a class=\"toc-link toc-link-h2\" href=\"#remove_actionremove_filter-の利用\">remove_action，remove_filter の利用</a></li><li class=\"toc-item toc-item-h2\"><a class=\"toc-link toc-link-h2\" href=\"#使いどころ\">使いどころ</a></li><li class=\"toc-item toc-item-h2\"><a class=\"toc-link toc-link-h2\" href=\"#まとめ\">まとめ</a></li></ol></nav></div><p>「add_action」や「add_filter」によってフックすることでWordPressの機能を拡張することができますが、闇雲に追加すると<span class=\"double-underline\">他で追加されたものと競合</span>して予期せぬ動作になってしまうことがあります。</p>\n\n<h2 id=\"remove_actionremove_filter-の利用\">remove_action，remove_filter の利用<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#remove_actionremove_filter-の利用\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h2>\n\n<p>以下のような記述をすると適用範囲を最小限にとどめ、他への影響も少なくなります。</p>\n\n<p>(PHP5.3以上)</p>\n\n<pre class=\"language-php\" style=\"background: #2e3440\"><code class=\"language-php\"><span style=\"color: #D8DEE9FF\">$func = function ( $wp_query ) use ( </span><span style=\"color: #D8DEE9\">&#x26;</span><span style=\"color: #D8DEE9FF\">$func ) {</span>\n<span style=\"color: #D8DEE9FF\">   /** @var \\WP_Query $wp_query */</span>\n<span style=\"color: #D8DEE9FF\">   $wp_query->set( 'posts_per_page', 6 );</span>\n<span style=\"color: #D8DEE9FF\">   remove_action( 'pre_get_posts', $func );</span>\n<span style=\"color: #D8DEE9FF\">};</span>\n<span style=\"color: #D8DEE9FF\">add_action( 'pre_get_posts', $func );</span></code></pre>\n\n<p>必ずしも無名関数を使用する必要はなく、普通に関数を定義して「add_action」や「remove_action」を呼べば同じように適用を最小限にすることもできます。</p>\n\n<pre class=\"language-php\" style=\"background: #2e3440\"><code class=\"language-php\"><span style=\"color: #D8DEE9FF\">function test_function( $wp_query ) {</span>\n<span style=\"color: #D8DEE9FF\">   /** @var \\WP_Query $wp_query */</span>\n<span style=\"color: #D8DEE9FF\">   $wp_query->set( 'posts_per_page', 6 );</span>\n<span style=\"color: #D8DEE9FF\">   remove_action( 'pre_get_posts', 'test_function' );</span>\n<span style=\"color: #D8DEE9FF\">}</span>\n<span style=\"color: #D8DEE9FF\">add_action( 'pre_get_posts', 'test_function' );</span></code></pre>\n\n<p>その場合はPHP5.3未満にも対応可能ですが、ちょっとした適用をしたい場合も将来にわたって他と被らない<span class=\"double-underline\">関数名をいちいち考える必要</span>があります。</p>\n\n<div class=\"blog-card\"><iframe src=\"https://blog-card-ten.vercel.app/card/https%3A%2F%2Felearn.jp%2Fwpman%2Ffunction%2Fremove_action.html?id=blog-card-e7f0kdgtn2&#x26;referrer=https%3A%2F%2Ftechnote.space%2Fposts%2Fwpxml-wordpress-minimum-apply-action-filter%2F\" frameborder=\"0\" scrolling=\"no\" loading=\"lazy\" data-id=\"blog-card-e7f0kdgtn2\"></iframe></div>\n\n<div class=\"blog-card\"><iframe src=\"https://blog-card-ten.vercel.app/card/https%3A%2F%2Felearn.jp%2Fwpman%2Ffunction%2Fremove_filter.html?id=blog-card-d6mm07ouob&#x26;referrer=https%3A%2F%2Ftechnote.space%2Fposts%2Fwpxml-wordpress-minimum-apply-action-filter%2F\" frameborder=\"0\" scrolling=\"no\" loading=\"lazy\" data-id=\"blog-card-d6mm07ouob\"></iframe></div>\n\n<h2 id=\"使いどころ\">使いどころ<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#使いどころ\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h2>\n\n<p>例に挙げたpre_get_postsはメインで表示するための投稿の取得やナビゲーションメニューの取得など、たいてい一回のページの表示で複数回呼ばれます。</p>\n\n<p><span class=\"double-underline\">特定のフィルタやアクションの後の一回だけで適用されればよい場合</span>は、そのフィルタやアクション内で上のような記述にしておけば別の個所で適用される心配はなくなります。</p>\n\n<p>さらに不要なフィルタやアクションを消すことで不要なプログラムが実行されなくなり、多少の高速化も望めます。</p>\n\n<p>ただし上記のような対応が全く不要なアクションやフィルタもあります。</p>\n\n<p>「init」や「template_redirect」のような一度だけしか呼ばれることがないものがそれにあたります。</p>\n\n<p>一度しか呼ばれないため remove してもしなくても動作としては何も変わりません。<br>むしろ remove する処理が無駄な負担になるため行わないほうがよいです。</p>\n\n<h2 id=\"まとめ\">まとめ<a aria-hidden=\"true\" tabindex=\"-1\" href=\"#まとめ\"><svg class=\"icon icon-link\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" width=\"20px\" height=\"20px\" viewBox=\"0 0 24 24\" aria-labelledby=\"paperclipIconTitle\" stroke=\"#2329EE\" stroke-width=\"1\" stroke-linecap=\"square\" stroke-linejoin=\"miter\" fill=\"none\" color=\"#131996\"><path d=\"M7.93517339,13.7795989 L15.1617306,6.55304173 C16.03921,5.67631227 17.4656766,5.67631227 18.343156,6.55304173 C19.2206355,7.43052116 19.2206355,8.85773771 18.343156,9.73521714 L8.40091248,19.5477137 C6.93619681,21.0124294 4.56325242,21.0124294 3.09853675,19.5477137 C1.63382108,18.083748 1.63382108,15.7093037 3.09853675,14.245338 L12.9335328,4.53783896 C14.9839848,2.48738701 18.3094068,2.48738701 20.3568588,4.53783896 C22.4088107,6.58904088 22.4088107,9.91146301 20.3583588,11.961915 L13.2390491,19.0819746\"></path></svg></a></h2>\n\n<p>プラグインやテーマを作成する場合はこのようなことを考慮して適切にremoveも行い、ほかのプラグインなどに影響を与えないようにする必要があります。</p>\n\n<p>逆にこのようなことが考慮されていないプラグインやテーマは<span class=\"double-underline\">作者がWordPressについてあまり詳しくなく、セキュリティやパフォーマンス的にまずい可能性がある</span>ため使用を避けたほうが無難です。</p>\n\n<p>かなり多くの人に利用されている大手の無料テーマやクラウドソーシングサービスでプロを名乗っている人が作っているプラグインでも致命的なセキュリティの問題を含んでいることがあります。</p>\n\n<figure class=\"wp-block-embed is-type-rich is-provider-technote\"><div class=\"wp-block-embed__wrapper\">\n<div class=\"blog-card\"><iframe src=\"https://blog-card-ten.vercel.app/card/https%3A%2F%2Ftechnote.space%2Fwordpress%2Ftheme-security-report?id=blog-card-95p2kffkli&#x26;referrer=https%3A%2F%2Ftechnote.space%2Fposts%2Fwpxml-wordpress-minimum-apply-action-filter%2F\" frameborder=\"0\" scrolling=\"no\" loading=\"lazy\" data-id=\"blog-card-95p2kffkli\"></iframe></div>\n</div></figure>\n\n<div class=\"blog-card\"><iframe src=\"https://blog-card-ten.vercel.app/card/https%3A%2F%2Ftechnote.space%2Fsecurity%2Ftroublesome?id=blog-card-623ns6b3i6&#x26;referrer=https%3A%2F%2Ftechnote.space%2Fposts%2Fwpxml-wordpress-minimum-apply-action-filter%2F\" frameborder=\"0\" scrolling=\"no\" loading=\"lazy\" data-id=\"blog-card-623ns6b3i6\"></iframe></div>\n\n<p>不安な場合は一度ソースコードを眺めて上記のようなことや nonceの使用によるCSRF対策、サニタイズやエスケープ処理によるXSS対策などが考慮されているか確認したほうがよいでしょう。</p>\n<!-- /wp:paragraph --></body></html>","excerpt":"「add_action」や「add_filter」によってフックすることでWordPressの機能を拡張することができますが、闇雲に追加すると他で追加されたものと競合して予期せぬ動作になってしまうことがあります。 REMOVE_ACTION...","postType":"post","tags":[{"slug":"php","name":"PHP"},{"slug":"wordpress","name":"WordPress"},{"slug":"%e3%82%a2%e3%82%af%e3%82%b7%e3%83%a7%e3%83%b3","name":"アクション"},{"slug":"%e3%83%95%e3%82%a3%e3%83%ab%e3%82%bf","name":"フィルタ"}],"thumbnail":"https://technote.space/uploads/2018/07/WordPress-logotype-wmark.png","dominantColor":"rgba(50,55,60,0.18823529411764706)","createdAt":"2018-10-27T20:02:25.000Z","updatedAt":null},"prev":{"id":"wpxml-programming-jquery-marker-animation","title":"マーカーアニメーションをjQueryプラグイン化してみた","excerpt":"画面に表示されたときにマーカー（蛍光ペン）で線を引くようなアニメーションを付けるjQueryプラグインを作成しました。 動作例 <a href=\"\">動作デモはこちら</a>    導入  ソースはGitHubで管理しています。    ダウ...","postType":"post","tags":[{"slug":"jquery","name":"jQuery"},{"slug":"marker-animation","name":"marker animation"},{"slug":"npm","name":"npm"},{"slug":"%e3%83%9e%e3%83%bc%e3%82%ab%e3%83%bc%e3%82%a2%e3%83%8b%e3%83%a1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3","name":"マーカーアニメーション"}],"thumbnail":"https://technote.space/uploads/2018/11/marker-animation.gif","createdAt":"2018-11-30T19:33:22.000Z","updatedAt":null},"next":{"id":"wpxml-security-wordpress-related-posts","title":"関連記事プラグイン「WordPress Related Posts」のメリット・デメリット","excerpt":"関連記事の表示はサイトの回遊率を上げるのに非常に有効な手段です。 WordPressでは関連記事を取得する機能はないため、プラグインを利用したり自分で実装する必要があります。 試しに「wordpress 関連記事 プラグイン」で調べてみると...","postType":"post","tags":[{"slug":"wordpress-related-posts","name":"WordPress Related Posts"},{"slug":"%e3%82%bb%e3%82%ad%e3%83%a5%e3%83%aa%e3%83%86%e3%82%a3","name":"セキュリティ"}],"thumbnail":"https://technote.space/uploads/2018/07/WordPress-logotype-wmark.png","createdAt":"2018-10-11T09:01:19.000Z","updatedAt":null},"headerPages":[],"footerPages":[{"label":"About","url":"/pages/wpxml-about/"},{"label":"プライバシーポリシー","url":"/pages/wpxml-privacy-policy/"},{"label":"お問い合わせ","url":"/pages/wpxml-contact/"}]},"__N_SSG":true}